<div id="chat-widget">
  <button id="chat-toggle">ðŸ’¬</button>

  <div id="chat-window" class="hidden">
    <div id="chat-header">
      <span>ðŸ¤– Asystent AI</span>
      <div class="chat-controls">
        <button id="chat-minimize">âž¤</button>
        <button id="chat-close">âœ•</button>
      </div>
    </div>

    <div id="chat-messages"></div>

    <form id="chat-form">
      <input
        type="text"
        id="chat-input"
        placeholder="Zapytaj o produkt, koszyk..."
        autocomplete="off"
      />
      <button type="submit">âž¤</button>
    </form>
  </div>
</div>

<style>

#chat-widget {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
  font-family: Arial, sans-serif;
}

#chat-toggle {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  border: none;
  background: #222;
  color: #fff;
  font-size: 24px;
  cursor: pointer;
}

#chat-window {
  width: 320px;
  height: 420px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  display: flex;
  flex-direction: column;
  position: absolute;
  bottom: 70px;
  right: 0;
  transition: transform 0.3s ease, opacity 0.3s ease;
}

#chat-window.hidden {
  display: none;
}

#chat-window.minimized {
  transform: translateX(280px);
  opacity: 0.3;
  pointer-events: none;
}

#chat-header {
  padding: 10px;
  background: #222;
  color: #fff;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 12px 12px 0 0;
}

.chat-controls button {
  background: none;
  border: none;
  color: #fff;
  font-size: 16px;
  cursor: pointer;
  margin-left: 6px;
}

#chat-messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  background: #f7f7f7;
}

.chat-message {
  margin-bottom: 10px;
  line-height: 1.4;
}

.chat-user {
  text-align: right;
  font-weight: bold;
  color: #333;
}

.chat-bot {
  text-align: left;
  color: #111;
}

#chat-form {
  display: flex;
  border-top: 1px solid #ddd;
}

#chat-input {
  flex: 1;
  border: none;
  padding: 10px;
  font-size: 14px;
}

#chat-form button {
  border: none;
  background: #222;
  color: #fff;
  padding: 0 16px;
  cursor: pointer;
}
</style>

<script>

const chatToggle = document.getElementById("chat-toggle");
const chatWindow = document.getElementById("chat-window");
const chatClose = document.getElementById("chat-close");
const chatMinimize = document.getElementById("chat-minimize");
const chatForm = document.getElementById("chat-form");
const chatInput = document.getElementById("chat-input");
const chatMessages = document.getElementById("chat-messages");
function clearChat() {
  chatMessages.innerHTML = "";
}

async function loadChatHistory() {
  clearChat();
  const res = await fetch("/api/chat/history", {
    credentials: "same-origin"
  });
  const history = await res.json();

  history.forEach(m => {
    addMessage(m.content, m.role === "user" ? "user" : "bot");
  });
}

chatToggle.onclick = () => {
  chatWindow.classList.remove("minimized");
  chatWindow.classList.toggle("hidden");
  loadChatHistory();
};

chatClose.onclick = () => {
  chatWindow.classList.add("hidden");
};

chatMinimize.onclick = () => {
  chatWindow.classList.add("minimized");
};

chatForm.onsubmit = async (e) => {
  e.preventDefault();
  const message = chatInput.value.trim();
  if (!message) return;

  addMessage(message, "user");
  chatInput.value = "";

  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      credentials: "same-origin", 
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message })
    });

    const data = await res.json();
    addMessage(data.reply, "bot");
  } catch {
    addMessage("CoÅ› poszÅ‚o nie tak ðŸ˜…", "bot");
  }
};

function addMessage(text, sender) {
  const div = document.createElement("div");
  div.className = `chat-message chat-${sender}`;
  div.innerHTML = text;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
</script>
